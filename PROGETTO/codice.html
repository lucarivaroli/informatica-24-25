#include <Wire.h>                   
#include <LiquidCrystal_I2C.h>      
    
    #define TRIG 7              
    #define ECHO 6
    #define RELAY 8
    #define LED_LUCE 5         
    #define LED_LAMPEGGIO 4    
    #define LUMINOSITA_PIN A0
    
    LiquidCrystal_I2C lcd(0x27, 20, 4);
    
    
    
    void lampeggiaLED(int pin, int lampeggi, int durata) {
        for (int i = 0; i < lampeggi; i++) {
            digitalWrite(pin, HIGH);
            delay(durata);
            digitalWrite(pin, LOW);
            delay(durata);
        }
    }
    
     
    void setup() {
        pinMode(TRIG, OUTPUT);
        pinMode(ECHO, INPUT);
        pinMode(RELAY, OUTPUT);
        pinMode(LED_LUCE, OUTPUT);
        pinMode(LED_LAMPEGGIO, OUTPUT);
        digitalWrite(RELAY, HIGH);       
    
        Serial.begin(9600);         
        lcd.init();                 
        lcd.backlight();            
        lcd.setCursor(0, 0);
        lcd.print("Distributore ON");
        delay(1000);
    }
    
    long misuraDistanza() {
        digitalWrite(TRIG, LOW);
        delayMicroseconds(2);           
        digitalWrite(TRIG, HIGH);                   
        delayMicroseconds(10);
        digitalWrite(TRIG, LOW);                    
    
        long durata = pulseIn(ECHO, HIGH);          
        long distanza = durata * 0.034 / 2;
        return distanza;
    }
    
   
    void loop() {
        long distanza = misuraDistanza();
        int luminosita = analogRead(LUMINOSITA_PIN);
    
        //stampa i valori sul monitor
        Serial.print("Distanza: ");
        Serial.print(distanza);
        Serial.print(" cm, LuminositÃ : ");
        Serial.println(luminosita);
    
        lcd.clear();                    
        lcd.print("Distanza: ");
        lcd.print(distanza);
        lcd.print("cm");
    
        lcd.setCursor(0, 1);
        if (distanza <= 10) {
            
            lampeggiaLED(LED_LAMPEGGIO, 3, 200);
    
            digitalWrite(RELAY, LOW);               
            lcd.print("Pompa: ACCESA");
            lcd.setCursor(0, 2);
            lcd.print("Grazie, arrivederci! ");
        } else {
            digitalWrite(RELAY, HIGH);
            lcd.print("Pompa: SPENTA");
            lcd.setCursor(0, 2);
            lcd.print("Metti il bicchiere! ");
        }
    
        
        if (luminosita < 35) {
            digitalWrite(LED_LUCE, HIGH);
        } else {
            digitalWrite(LED_LUCE, LOW);
        }
    
        delay(500);
    }



